#!/bin/bash

if [ $# -eq 0 ]; then
  echo "Supply filename as argument"
  exit 1;
fi

filepath=$(realpath $1)
directory=$(dirname $filepath)
filename=$(basename -- "$filepath")
extension="${filename##*.}"
filename="${filename%.*}"
first_run=true

if [ ! -f $filepath ]; then
  echo "Input file not found"
  exit 1;
fi

echo "Starting..."
while true; do

  echo "Extension: $extension"
  case $extension in
    "asy")
      echo "Re-rendering..."
      outfile="$directory/$filename.eps"
      asy --render 0 $filepath -o $outfile
      ;;
    "tex")
      outfile="$directory/$filename.pdf"
      pdflatex $filepath --output-directory $directory
      ;;
  esac

  if [ "$first_run" = true ]; then
    echo "First run"
    xdg-open $outfile;
    first_run=false;
  fi

  # Block execution until file write
  inotifywait -e CLOSE_WRITE $filepath;
done
